
 --================statement 1================ 
DROP TABLE IF EXISTS AU_EDW.EDW_PHARMACY_ECOMMERCE_ANALYSIS;

 --================statement 2================ 
CREATE TABLE AU_EDW.EDW_PHARMACY_ECOMMERCE_ANALYSIS AS
SELECT
  PEF.WEEK_END_DT
  ETD.JJ_YEAR,
  ETD.JJ_QRTR,
  ETD.JJ_MNTH,
  ETD.JJ_WK,
  ETD.JJ_MNTH_ID,
  ETD.JJ_MNTH_TOT,
  ETD.JJ_MNTH_DAY,
  ETD.JJ_MNTH_SHRT,
  ETD.JJ_MNTH_LONG,
  ETD.CAL_YEAR,
  ETD.CAL_QRTR,
  ETD.CAL_MNTH,
  ETD.CAL_MNTH_ID,
  ETD.CAL_MNTH_NM,
  EPPD.PROD_KEY,
  PEF.PRODUCT_PROBE_ID,
  EPPD.PROD_DESC,
  EPPD.PROD_ID AS PROD_SAPBW_CODE,
  EPPD.PROD_EAN,
  EPPD.PROD_JJ_FRANCHISE,
  EPPD.PROD_JJ_CATEGORY,
  PEF.CATEGORY AS IQVIA_PROD_CATEGORY,
  EPPD.PROD_JJ_BRAND,
  EPPD.PROD_SAP_FRANCHISE,
  EPPD.PROD_SAP_PROFIT_CENTRE,
  EPPD.PROD_SAP_PRODUCT_MAJOR,
  EPPD.PROD_GROCERY_FRANCHISE,
  EPPD.PROD_GROCERY_CATEGORY,
  EPPD.PROD_GROCERY_BRAND,
  EPPD.PROD_PBS,
  EPPD.PROD_IMS_BRAND,
  EPPD.PROD_NZ_CODE,
  GCH.GCPH_FRANCHISE,
  GCH.GCPH_BRAND,
  GCH.GCPH_SUBBRAND,
  GCH.GCPH_VARIANT,
  GCH.GCPH_NEEDSTATE,
  GCH.GCPH_CATEGORY,
  GCH.GCPH_SUBCATEGORY,
  GCH.GCPH_SEGMENT,
  GCH.GCPH_SUBSEGMENT,
  PEF.CUST_GROUP,
  CASE
    WHEN UPPER(PEF.CUST_GROUP) = 'OTHER AURX'
    THEN 'Other AU Pharmacy'
    WHEN UPPER(PEF.CUST_GROUP) = 'CHW'
    THEN 'Chemist Warehouse'
    ELSE PEF.CUST_GROUP
  END AS ECOMM_CUST,
  PEF.OWNER,
  PEF.MANUFACTURER,
  PEF.SALES_QTY AS UNIT_ONLINE,
  PEF.SALES_VALUE AS AUD_SALES_ONLINE,
  BWAR.EXCH_RATE AS EXCH_RATE_TO_USD,
  PEF.SALES_VALUE * BWAR.EXCH_RATE AS USD_SALES_ONLINE
FROM AU_EDW.EDW_AU_PHARM_ECOMM_FACT AS PEF
LEFT JOIN AU_EDW.EDW_TIME_DIM AS ETD
  ON PEF.WEEK_END_DT = TRUNC(ETD.CAL_DATE)
/* Negelecting the duplicate Probe ID from DIM table */
LEFT JOIN (
  SELECT
    *
  FROM AU_EDW.EDW_PERENSO_PROD_PROBEID_DIM
  WHERE
    NOT PRODUCT_PROBE_ID IN (
      SELECT DISTINCT
        PRODUCT_PROBE_ID
      FROM AU_EDW.EDW_PERENSO_PROD_PROBEID_DIM
      GROUP BY
        1
      HAVING
        COUNT(*) > 1
    )
) AS EPPD
  ON PEF.PRODUCT_PROBE_ID = EPPD.PRODUCT_PROBE_ID
/* Used same query from Sales_reporting view as per requirement */
LEFT JOIN (
  SELECT
    MATERIALNUMBER,
    GCPH_FRANCHISE,
    GCPH_BRAND,
    GCPH_SUBBRAND,
    GCPH_VARIANT,
    GCPH_NEEDSTATE,
    GCPH_CATEGORY,
    GCPH_SUBCATEGORY,
    GCPH_SEGMENT,
    GCPH_SUBSEGMENT
  FROM RG_EDW.EDW_GCH_PRODUCTHIERARCHY
  WHERE
    LTRIM(MATERIALNUMBER, 0) <> '' AND REGION = 'APAC'
) AS GCH
  ON LTRIM(EPPD.PROD_ID, 0) = LTRIM(GCH.MATERIALNUMBER, 0)
LEFT JOIN (
  SELECT
    *
  FROM AU_EDW.VW_BWAR_CURR_EXCH_DIM
  WHERE
    TO_CCY = 'USD'
) AS BWAR
  ON ETD.JJ_MNTH_ID = BWAR.JJ_MNTH_ID AND PEF.CRNCY = BWAR.FROM_CCY
WHERE
  DATEDIFF(MONTH, PEF.WEEK_END_DT, CURRENT_DATE) <= 24;
