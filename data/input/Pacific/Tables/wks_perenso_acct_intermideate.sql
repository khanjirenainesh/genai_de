
 --================statement 1================ 
DELETE   au_wks.wks_perenso_acct_intermideate;

 --================statement 2================ 
INSERT INTO au_wks.wks_perenso_acct_intermideate
SELECT DISTINCT
  ACCT_KEY,
  FIELD_KEY,
  ACCT_GRP_LEV_KEY,
  ACCT_GRP_KEY,
  FIELD_DESC,
  ACCT_LEV_DESC,
  GRP_DESC
FROM (
  SELECT
    IPA.ACCT_KEY,
    IPAGR.ACCT_GRP_KEY,
    IPAG.GRP_DESC,
    IPAG.ACCT_GRP_LEV_KEY,
    IPAGL.ACCT_LEV_DESC,
    IPAGL.FIELD_KEY,
    IPAF.FIELD_DESC
  FROM AU_ITG.ITG_PERENSO_ACCOUNT AS IPA, AU_ITG.ITG_PERENSO_ACCOUNT_TYPE AS IPAT, AU_ITG.ITG_PERENSO_ACCOUNT_GROUP_RELN AS IPAGR, AU_ITG.ITG_PERENSO_ACCOUNT_GROUP AS IPAG, AU_ITG.ITG_PERENSO_ACCOUNT_GROUP_LVL AS IPAGL, AU_ITG.ITG_PERENSO_ACCOUNT_FIELDS AS IPAF
  WHERE
    IPA.ACCT_TYPE_KEY = IPAT.ACCT_TYPE_KEY
    AND IPA.ACCT_KEY = IPAGR.ACCT_KEY
    AND IPAGR.ACCT_GRP_KEY = IPAG.ACCT_GRP_KEY
    AND IPAG.ACCT_GRP_LEV_KEY = IPAGL.ACCT_GRP_LEV_KEY
    AND IPAGL.FIELD_KEY = IPAF.FIELD_KEY
  UNION
  SELECT
    ACCT_KEY,
    ACCT_GRP_KEY,
    GRP_DESC,
    ACCT_GRP_LEV_KEY,
    ACCT_LEV_DESC,
    FIELD_KEY,
    FIELD_DESC
  FROM (
    SELECT
      IPA.ACCT_KEY,
      TRY_CAST('999999' AS DECIMAL) AS ACCT_GRP_KEY,
      IPARI.ID AS GRP_DESC,
      TRY_CAST('999999' AS DECIMAL) AS ACCT_GRP_LEV_KEY,
      NULL AS ACCT_LEV_DESC,
      IPARI.FIELD_KEY,
      IPAF.FIELD_DESC,
      COUNT(IPA.ACCT_KEY) OVER (PARTITION BY IPA.ACCT_KEY) AS CNT
    FROM AU_ITG.ITG_PERENSO_ACCOUNT AS IPA, AU_ITG.ITG_PERENSO_ACCOUNT_TYPE AS IPAT, AU_ITG.ITG_PERENSO_ACCOUNT_FIELDS AS IPAF, AU_ITG.ITG_PERENSO_ACCOUNT_RELN_ID AS IPARI
    WHERE
      IPA.ACCT_TYPE_KEY = IPAT.ACCT_TYPE_KEY
      AND IPAF.ACCT_TYPE_KEY = IPAT.ACCT_TYPE_KEY
      AND IPARI.FIELD_KEY = IPAF.FIELD_KEY()
      AND IPA.ACCT_KEY = IPARI.ACCT_KEY()
      AND UPPER(IPAF.FIELD_DESC) = 'STORE CODE'
  )
  WHERE
    CNT <> '2'
  UNION
  SELECT
    ACCT_KEY,
    ACCT_GRP_KEY,
    GRP_DESC,
    ACCT_GRP_LEV_KEY,
    ACCT_LEV_DESC,
    FIELD_KEY,
    FIELD_DESC
  FROM (
    SELECT
      IPA.ACCT_KEY,
      TRY_CAST('999999' AS DECIMAL) AS ACCT_GRP_KEY,
      IPARI.OPTION_DESC AS GRP_DESC,
      TRY_CAST('999999' AS DECIMAL) AS ACCT_GRP_LEV_KEY,
      NULL AS ACCT_LEV_DESC,
      IPARI.FIELD_KEY,
      IPAF.FIELD_DESC,
      COUNT(IPA.ACCT_KEY) OVER (PARTITION BY IPA.ACCT_KEY, IPARI.FIELD_KEY) AS CNT
    FROM AU_ITG.ITG_PERENSO_ACCOUNT AS IPA, AU_ITG.ITG_PERENSO_ACCOUNT_TYPE AS IPAT, AU_ITG.ITG_PERENSO_ACCOUNT_FIELDS AS IPAF, AU_ITG.ITG_PERENSO_ACCOUNT_CUSTOM_LIST AS IPARI
    WHERE
      IPA.ACCT_TYPE_KEY = IPAT.ACCT_TYPE_KEY
      AND IPAF.ACCT_TYPE_KEY = IPAT.ACCT_TYPE_KEY
      AND IPARI.FIELD_KEY = IPAF.FIELD_KEY()
      AND IPA.ACCT_KEY = IPARI.ACCT_KEY
  )
  WHERE
    CNT <> '2'
);
