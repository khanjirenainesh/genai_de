
 --================statement 1================ 
DROP TABLE IF EXISTS AU_WKS.WKS_AU_PHARM_ECOMM_DATA;

 --================statement 2================ 
CREATE TABLE AU_WKS.wks_au_pharm_ecomm_data AS
SELECT
  'National' AS CUST_GROUP,
  PRODUCT_PROBE_ID,
  PRODUCT_NAME,
  NEC1_DESC,
  NEC2_DESC,
  NEC3_DESC,
  BRAND,
  CATEGORY,
  OWNER,
  MANUFACTURER,
  MAT_YEAR,
  TIME_PERIOD,
  WEEK_END_DT,
  SALES_VALUE,
  SALES_QTY,
  CRNCY
FROM AU_ITG.ITG_NATIONAL_ECOMM_DATA
UNION ALL
SELECT
  'CHW' AS CUST_GROUP,
  PRODUCT_PROBE_ID,
  PRODUCT_NAME,
  NEC1_DESC,
  NEC2_DESC,
  NEC3_DESC,
  BRAND,
  CATEGORY,
  OWNER,
  MANUFACTURER,
  MAT_YEAR,
  TIME_PERIOD,
  WEEK_END_DT,
  SALES_VALUE,
  SALES_QTY,
  CRNCY
FROM AU_ITG.ITG_CHW_ECOMM_DATA
UNION ALL
SELECT
  'Other AURX' AS CUST_GROUP,
  A.PRODUCT_PROBE_ID,
  A.PRODUCT_NAME,
  A.NEC1_DESC,
  A.NEC2_DESC,
  A.NEC3_DESC,
  A.BRAND,
  A.CATEGORY,
  A.OWNER,
  A.MANUFACTURER,
  A.MAT_YEAR,
  A.TIME_PERIOD,
  A.WEEK_END_DT,
  (
    COALESCE(A.SALES_VALUE, 0) - COALESCE(B.SALES_VALUE, 0)
  ) AS SALES_VALUE,
  (
    COALESCE(A.SALES_QTY, 0) - COALESCE(B.SALES_QTY, 0)
  ) AS SALES_QTY,
  A.CRNCY
FROM AU_ITG.ITG_NATIONAL_ECOMM_DATA AS A
LEFT JOIN (
  SELECT
    *
  FROM AU_ITG.ITG_CHW_ECOMM_DATA
  WHERE
    NOT UPPER(CATEGORY) IN ('TOILET SOAP', 'DEODORANTS', 'FEMININE HYGIENE', 'COSMETICS', 'THROAT PREPARATIONS', 'EYE CARE', 'URINARY', 'PAPER PRODUCTS', 'FOOT CARE')
) AS B
  ON A.PRODUCT_PROBE_ID = B.PRODUCT_PROBE_ID
  AND UPPER(A.OWNER) = UPPER(B.OWNER)
  AND A.WEEK_END_DT = B.WEEK_END_DT;

 --================statement 3================ 
TRUNCATE AU_EDW.EDW_AU_PHARM_ECOMM_FACT;

 --================statement 4================ 
insert into au_edw.edw_au_pharm_ecomm_fact
select
  *,
  current_timestamp()
from au_wks.wks_au_pharm_ecomm_data;

 --================statement 5================ 
DROP TABLE IF EXISTS AU_WKS.WKS_AU_PHARM_ECOMM_DATA;
